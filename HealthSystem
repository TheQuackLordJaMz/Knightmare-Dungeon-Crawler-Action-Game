using UnityEngine;
using UnityEngine.Events;
using System.Collections;
using System.Collections.Generic;

// This script manages the life and death of any object it's attached to (Player or Enemy).
public class HealthSystem : MonoBehaviour
{
    [Header("Health Settings")]
    public float maxHealth = 100f;
    public float currentHealth;
    public HealthBar healthBar; // Reference to the UI slider script
    public UnityEvent onDeath;  // Triggered when health reaches zero

    [Header("Hit Flash Settings")]
    public float flashDuration = 0.2f; // Total time the blinking lasts
    public int flashCount = 2;         // Number of times the mesh toggles off/on

    void Start()
    {
        // Initialize health at the start of the game/spawn
        currentHealth = maxHealth;

        // Push initial values to the UI if a health bar is assigned
        if (healthBar != null)
            healthBar.UpdateHealthBar(maxHealth, currentHealth);
    }

    /// <summary>
    /// Subtracts value from health, updates UI, and checks for death.
    /// </summary>
    public void TakeDamage(float damage)
    {
        if (currentHealth <= 0) return; // Ignore damage if already dead

        currentHealth -= damage;

        // Sync the UI health bar with the new health value
        if (healthBar != null)
            healthBar.UpdateHealthBar(maxHealth, currentHealth);

        // Visual feedback so the player knows a hit registered
        StartCoroutine(FlashRoutine());

        if (currentHealth <= 0)
        {
            Die();
        }
    }

    /// <summary>
    /// Restores health up to the MaxHealth limit. Called by pickups.
    /// </summary>
    public void Heal(float amount)
    {
        if (currentHealth <= 0) return; // Dead things can't heal

        // Add health but cap it so it never exceeds maxHealth
        currentHealth = Mathf.Min(currentHealth + amount, maxHealth);

        if (healthBar != null)
            healthBar.UpdateHealthBar(maxHealth, currentHealth);

        Debug.Log($"<color=green>Healed!</color> Current Health: {currentHealth}");
    }

    // Coroutine: Briefly hides/shows renderers to create a "damage blink" effect
    private IEnumerator FlashRoutine()
    {
        // Gather all renderers (body, armor, weapons) to flash them all together
        Renderer[] allRenderers = GetComponentsInChildren<Renderer>();
        List<Renderer> activeRenderers = new List<Renderer>();

        foreach (var r in allRenderers)
        {
            if (r.enabled) activeRenderers.Add(r);
        }

        for (int i = 0; i < flashCount; i++)
        {
            foreach (var r in activeRenderers) r.enabled = false;
            yield return new WaitForSeconds(flashDuration / (flashCount * 2));

            foreach (var r in activeRenderers) r.enabled = true;
            yield return new WaitForSeconds(flashDuration / (flashCount * 2));
        }

        // Safety: Ensure renderers are visible after the loop ends
        foreach (var r in activeRenderers) r.enabled = true;
    }

    private void Die()
    {
        // Trigger any external death logic (animations, game over screens)
        if (onDeath != null) onDeath.Invoke();

        // If it's the Player, we stop here (PlayerCollisions handles the rest)
        if (gameObject.CompareTag("Player")) return;

        // If it's an Enemy, stop all logic and remove it from the game
        StopAllCoroutines();
        Destroy(gameObject, 0.5f);
    }
}
